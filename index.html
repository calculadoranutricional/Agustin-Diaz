<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Calculadora Nutricional</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- TypeScript compilador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.3.3/typescript.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    color: #333;
    line-height: 1.4;
  }

  h1, h2 {
    font-weight: 500;
  }

  select, input, button {
    padding: 6px 10px;
    font-size: 14px;
    margin: 4px 0;
    border: 1px solid #bbb;
    border-radius: 4px;
  }

  button {
    cursor: pointer;
    background: #eaeaea;
  }

  button:hover {
    background: #dcdcdc;
  }

  table {
    border-collapse: collapse;
    margin: 10px 0;
    width: 100%;
  }

  th, td {
    border: 1px solid #CCC;
    padding: 6px;
    text-align: left;
  }

  .hidden {
    display: none;
  }

  ul {
    list-style: none;
    padding-left: 0;
    margin: 4px 0;
  }

  ul li button {
    width: 100%;
    text-align: left;
    background: #f5f5f5;
    border: 1px solid #ccc;
  }

  /* Dropdown minimalista */
  #selector-total {
    display: inline-block;
    position: relative;
    margin-left: 10px;
  }

  #menu-total {
    position: absolute;
    left: 0;
    top: 30px;
    background: white;
    border: 1px solid #bbb;
    padding: 10px;
    display: none;
    z-index: 20;
  }
</style>
</head>

<body>

<h1>Calculadora Nutricional</h1>

<div id="contenedor-comidas"></div>

<h2>Total</h2>

<!-- Botón mostrar + dropdown -->
<button onclick="toggleSeccion('total')">Mostrar tabla y gráfico</button>

<div id="selector-total">
  <button onclick="toggleDropdown()">Incluir en total ▼</button>

  <div id="menu-total">
    <!-- Checkboxes generados dinámicamente -->
    <label><input type="checkbox" class="chk-total" value="Desayuno" checked> Desayuno</label><br>
    <label><input type="checkbox" class="chk-total" value="Almuerzo" checked> Almuerzo</label><br>
    <label><input type="checkbox" class="chk-total" value="Merienda" checked> Merienda</label><br>
    <label><input type="checkbox" class="chk-total" value="Cena" checked> Cena</label>
  </div>
</div>

<div id="seccion-total" class="hidden">
  <table>
    <thead>
      <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>%VDR</th></tr>
    </thead>
    <tbody id="tabla-total"></tbody>
  </table>

  <canvas id="grafico-total"></canvas>
</div>

<!-- ================================================================ -->
<!--   TYPECRIPT REAL – SE COMPILA AUTOMÁTICAMENTE EN ESTE MISMO HTML -->
<!-- ================================================================ -->

<script type="text/typescript" id="ts-code">
// @ts-check

/* =============================
   Interfaces TypeScript
============================= */
type Nutriente = { nombre: string; unidad: string };
type Composicion = { [nutriente: string]: number };
type Alimento = { nombre: string; categoria: string; composicion: Composicion };
type RegistroComida = { alimento: Alimento; peso: number };
type Totales = { [nutriente: string]: number };

/* =============================
   Datos base
============================= */
const comidas: string[] = ["Desayuno", "Almuerzo", "Merienda", "Cena"];

const categorias: string[] = ["Frutas", "Verduras", "Cereales", "Lácteos", "Carnes"];

const nutrientes: Nutriente[] = [
  { nombre: "Proteínas", unidad: "g" },
  { nombre: "Carbohidratos", unidad: "g" },
  { nombre: "Grasas totales", unidad: "g" },
  { nombre: "Fibra", unidad: "g" },
  { nombre: "Hierro", unidad: "mg" },
  { nombre: "Calcio", unidad: "mg" }
];

const vdr: Record<string, number> = {
  Proteínas: 50,
  Carbohidratos: 300,
  "Grasas totales": 70,
  Fibra: 25,
  Hierro: 18,
  Calcio: 1000
};

const alimentos: Alimento[] = [
  { nombre: "Manzana", categoria: "Frutas", composicion: { Carbohidratos: 14, Fibra: 2.4 } },
  { nombre: "Leche", categoria: "Lácteos", composicion: { Proteínas: 3.4, "Grasas totales": 1, Calcio: 120 } },
  { nombre: "Pan integral", categoria: "Cereales", composicion: { Carbohidratos: 40, Proteínas: 8, Fibra: 6 } },
  { nombre: "Espinaca", categoria: "Verduras", composicion: { Fibra: 2.2, Hierro: 2.7, Calcio: 99 } },
  { nombre: "Pechuga de pollo", categoria: "Carnes", composicion: { Proteínas: 31, "Grasas totales": 3.6 } }
];

/* =============================
   Estado global
============================= */
const datosComidas: Record<string, RegistroComida[]> = {};
const datosManuales: Record<string, Record<string, number>> = {};
const graficos: Record<string, any> = {};

const contenedor = document.getElementById("contenedor-comidas")!;

/* =============================
   Mostrar/Ocultar secciones
============================= */
(window as any).toggleSeccion = (id: string) => {
  const sec = document.getElementById("seccion-" + id)!;
  const btn = event!.target as HTMLButtonElement;

  const oculto = sec.classList.contains("hidden");
  sec.classList.toggle("hidden");
  btn.textContent = oculto ? "Ocultar tabla y gráfico" : "Mostrar tabla y gráfico";
};

/* =============================
   Dropdown total
============================= */
(window as any).toggleDropdown = () => {
  const menu = document.getElementById("menu-total")!;
  menu.style.display = menu.style.display === "block" ? "none" : "block";
};

/* =============================
   Render dinámico de secciones
============================= */
comidas.forEach(comida => {
  datosComidas[comida] = [];
  datosManuales[comida] = {};

  const div = document.createElement("div");
  div.innerHTML = `
    <h2>${comida}</h2>

    <select id="cat-${comida}">
      <option value="">Todas las categorías</option>
      ${categorias.map(c => `<option value="${c}">${c}</option>`).join("")}
    </select>

    <input id="buscar-${comida}" placeholder="Buscar alimento" />
    <ul id="sugerencias-${comida}"></ul>

    <input id="peso-${comida}" type="number" placeholder="Peso (g)" />

    <button id="add-${comida}">Agregar</button>
    <button onclick="toggleSeccion('${comida}')">Mostrar tabla y gráfico</button>

    <div id="seccion-${comida}" class="hidden">
      <table>
        <thead>
          <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>%VDR</th></tr>
        </thead>
        <tbody id="tabla-${comida}"></tbody>
      </table>

      <canvas id="grafico-${comida}"></canvas>

      <h3>Editor Manual</h3>
      <table>
        <thead>
          <tr><th>Nutriente</th><th>Cantidad</th><th>Unidad</th><th>%VDR</th></tr>
        </thead>
        <tbody id="editor-${comida}"></tbody>
      </table>

      <button id="aplicar-${comida}">Aplicar nutrientes</button>
    </div>
  `;

  contenedor.appendChild(div);

  renderAutocompletado(comida);
  renderEditor(comida);
});

/* =============================
   Autocompletado
============================= */
function renderAutocompletado(comida: string) {
  const inputBuscar = document.getElementById(`buscar-${comida}`) as HTMLInputElement;
  const selectorCat = document.getElementById(`cat-${comida}`) as HTMLSelectElement;
  const ulSug = document.getElementById(`sugerencias-${comida}`)!;
  const inputPeso = document.getElementById(`peso-${comida}`) as HTMLInputElement;
  const btnAgregar = document.getElementById(`add-${comida}`)!;

  function actualizar() {
    const val = inputBuscar.value.toLowerCase();
    const cat = selectorCat.value;

    const sugerencias = alimentos
      .filter(a =>
        a.nombre.toLowerCase().includes(val) &&
        (!cat || a.categoria === cat)
      )
      .map(a => `<li><button data-nombre="${a.nombre}">${a.nombre}</button></li>`);

    ulSug.innerHTML = sugerencias.join("");
  }

  inputBuscar.addEventListener("input", actualizar);
  selectorCat.addEventListener("change", actualizar);

  ulSug.addEventListener("click", e => {
    const btn = e.target as HTMLElement;
    if (btn.dataset.nombre) {
      inputBuscar.value = btn.dataset.nombre;
      ulSug.innerHTML = "";
    }
  });

  btnAgregar.addEventListener("click", () => {
    const nombre = inputBuscar.value.trim();
    const peso = parseFloat(inputPeso.value);
    const alimento = alimentos.find(a => a.nombre === nombre);

    if (!alimento || !peso) return;

    datosComidas[comida].push({ alimento, peso });
    calcular();
  });
}

/* =============================
   Editor manual
============================= */
function renderEditor(comida: string) {
  const editor = document.getElementById(`editor-${comida}`)!;

  nutrientes.forEach(n => {
    datosManuales[comida][n.nombre] = 0;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${n.nombre}</td>
      <td><input id="input-${comida}-${n.nombre}" type="number" value="0"></td>
      <td>${n.unidad}</td>
      <td id="vdr-${comida}-${n.nombre}">0%</td>
    `;

    editor.appendChild(row);

    const input = document.getElementById(`input-${comida}-${n.nombre}`)! as HTMLInputElement;

    input.addEventListener("input", () => {
      const val = parseFloat(input.value) || 0;
      datosManuales[comida][n.nombre] = val;

      const porc = (val / vdr[n.nombre]) * 100;
      document.getElementById(`vdr-${comida}-${n.nombre}`)!.textContent = porc.toFixed(1) + "%";
    });
  });

  document.getElementById(`aplicar-${comida}`)!.addEventListener("click", () => {
    const alimento: Alimento = {
      nombre: "Manual",
      categoria: "Manual",
      composicion: {}
    };

    nutrientes.forEach(n => {
      alimento.composicion[n.nombre] = datosManuales[comida][n.nombre];
    });

    datosComidas[comida].push({ alimento, peso: 100 });
    calcular();
  });
}

/* =============================
   Render tabla
============================= */
function renderTabla(comida: string, totales: Totales) {
  const tabla = document.getElementById(`tabla-${comida}`);
  if (!tabla) return;

  tabla.innerHTML = "";

  nutrientes.forEach(n => {
    const val = totales[n.nombre] || 0;
    const porc = (val / vdr[n.nombre]) * 100;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${n.nombre}</td>
      <td>${val.toFixed(2)}</td>
      <td>${n.unidad}</td>
      <td>${porc.toFixed(1)}%</td>
    `;

    tabla.appendChild(row);
  });
}

/* =============================
   Render gráfico
============================= */
function renderGrafico(comida: string, totales: Totales) {
  const canvas = document.getElementById(`grafico-${comida}`) as HTMLCanvasElement;
  if (!canvas) return;

  const ctx = canvas.getContext("2d")!;

  const labels = ["Proteínas", "Carbohidratos", "Grasas totales"];
  const datos = labels.map(n => totales[n]);

  if (graficos[comida]) graficos[comida].destroy();

  graficos[comida] = new (window as any).Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [
        {
          data: datos,
          backgroundColor: ["#4CAF50", "#FFEB3B", "#F44336"]
        }
      ]
    },
    options: { responsive: true }
  });
}

/* =============================
   Cálculo total
============================= */
function calcular() {
  const checks = document.querySelectorAll(".chk-total") as NodeListOf<HTMLInputElement>;

  const seleccionadas = Array.from(checks)
    .filter(c => c.checked)
    .map(c => c.value);

  datosComidas["total"] = [];

  seleccionadas.forEach(comida => {
    datosComidas[comida].forEach(reg => datosComidas["total"].push(reg));
  });

  [...comidas, "total"].forEach(comida => {
    const totales: Totales = {};
    nutrientes.forEach(n => (totales[n.nombre] = 0));

    datosComidas[comida].forEach(({ alimento, peso }) => {
      nutrientes.forEach(n => {
        totales[n.nombre] += (alimento.composicion[n.nombre] || 0) * peso / 100;
      });
    });

    renderTabla(comida, totales);
    renderGrafico(comida, totales);
  });
}
</script>

<!-- ============================================= -->
<!--  EJECUTA EL TYPESCRIPT TRANSFORMADO A JAVASCRIPT -->
<!-- ============================================= -->
<script>
  const tsCode = document.getElementById("ts-code").textContent;
  const jsCode = ts.transpile(tsCode);
  eval(jsCode);
</script>

</body>
</html>